<!-- Page Header -->
<div class="mb-8">
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Chi tiết đơn hàng</h1>
            <p class="mt-2 text-gray-600">Thông tin chi tiết đơn hàng #<%= order._id.toString().substring(0, 8) %></p>
        </div>
        <div class="flex space-x-3">
            <a href="/admin/orders" class="inline-flex items-center px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-lg hover:bg-gray-700 transition-colors">
                <i class="ri-arrow-left-line mr-2"></i>
                Quay lại
            </a>
        </div>
    </div>
</div>

<!-- Success/Error Messages -->
<% if (message) { %>
    <div class="mb-6 p-4 rounded-lg <%= messageType === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 'bg-red-100 text-red-800 border border-red-200' %>">
        <div class="flex items-center">
            <i class="ri-<%= messageType === 'success' ? 'check' : 'error-warning' %>-line mr-2"></i>
            <%= message %>
        </div>
    </div>
<% } %>

<!-- Order Information -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
    <!-- Order Details -->
    <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Thông tin đơn hàng</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="text-sm font-medium text-gray-500">Mã đơn hàng</label>
                    <p class="text-sm text-gray-900">#<%= order._id.toString().substring(0, 8) %></p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Ngày tạo</label>
                    <p class="text-sm text-gray-900"><%= order.createdAt ? new Date(order.createdAt).toLocaleDateString('vi-VN') : 'N/A' %></p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Trạng thái</label>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= 
                        order.status === 'completed' ? 'bg-green-100 text-green-800' :
                        order.status === 'processing' ? 'bg-blue-100 text-blue-800' :
                        order.status === 'shipped' ? 'bg-yellow-100 text-yellow-800' :
                        order.status === 'cancelled' ? 'bg-red-100 text-red-800' :
                        'bg-gray-100 text-gray-800'
                    %>">
                        <%= order.status === 'completed' ? 'Hoàn thành' :
                            order.status === 'processing' ? 'Đang xử lý' :
                            order.status === 'shipped' ? 'Đã giao hàng' :
                            order.status === 'cancelled' ? 'Đã hủy' :
                            'Chờ xử lý'
                        %>
                    </span>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Thanh toán</label>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= 
                        order.paymentStatus === 'paid' ? 'bg-green-100 text-green-800' :
                        order.paymentStatus === 'failed' ? 'bg-red-100 text-red-800' :
                        'bg-yellow-100 text-yellow-800'
                    %>">
                        <%= order.paymentStatus === 'paid' ? 'Đã thanh toán' :
                            order.paymentStatus === 'failed' ? 'Thất bại' :
                            'Chờ thanh toán'
                        %>
                    </span>
                </div>
            </div>
        </div>

        <!-- Order Items -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Sản phẩm trong đơn hàng</h3>
            <% if (order.items && order.items.length > 0) { %>
                <div class="space-y-4">
                    <% order.items.forEach((item, index) => { %>
                        <div class="flex items-center space-x-4 p-4 border border-gray-200 rounded-lg">
                            <div class="flex-shrink-0">
                                <% if (item.imageUrl) { %>
                                    <img class="h-16 w-16 rounded-lg object-cover" src="<%= item.imageUrl %>" alt="<%= item.title %>">
                                <% } else { %>
                                    <div class="h-16 w-16 rounded-lg bg-gray-300 flex items-center justify-center">
                                        <i class="ri-image-line text-gray-500 text-xl"></i>
                                    </div>
                                <% } %>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="text-sm font-medium text-gray-900 truncate"><%= item.title %></h4>
                                <p class="text-sm text-gray-500">SKU: <%= item.product && item.product.sku ? item.product.sku : (item.productId ? item.productId.toString().substring(0, 8) : 'N/A') %></p>
                                <p class="text-sm text-gray-500">Số lượng: <%= item.quantity %></p>
                            </div>
                            <div class="flex-shrink-0 text-right">
                                <p class="text-sm font-medium text-gray-900"><%= item.price ? item.price.toLocaleString('vi-VN') : 0 %>₫</p>
                                <p class="text-sm text-gray-500">Tổng: <%= (item.price * item.quantity).toLocaleString('vi-VN') %>₫</p>
                            </div>
                        </div>
                    <% }); %>
                </div>
            <% } else { %>
                <div class="text-center py-8">
                    <i class="ri-shopping-bag-line text-4xl text-gray-300 mb-2"></i>
                    <p class="text-gray-500">Không có sản phẩm nào trong đơn hàng</p>
                </div>
            <% } %>
        </div>
    </div>

    <!-- Customer Info & Actions -->
    <div class="space-y-6">
        <!-- Customer Information -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Thông tin khách hàng</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-sm font-medium text-gray-500">Tên khách hàng</label>
                    <p class="text-sm text-gray-900"><%= order.shippingInfo ? order.shippingInfo.name : 'N/A' %></p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Email</label>
                    <p class="text-sm text-gray-900"><%= order.shippingInfo ? order.shippingInfo.email : 'N/A' %></p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Số điện thoại</label>
                    <p class="text-sm text-gray-900"><%= order.shippingInfo ? order.shippingInfo.phone : 'N/A' %></p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Địa chỉ</label>
                    <p class="text-sm text-gray-900"><%= order.shippingInfo ? order.shippingInfo.address : 'N/A' %></p>
                </div>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Tổng kết đơn hàng</h3>
            <div class="space-y-3">
                <% 
                // Tính tổng tiền hàng từ các sản phẩm
                let subtotal = 0;
                if (order.items && order.items.length > 0) {
                    subtotal = order.items.reduce((sum, item) => {
                        return sum + (item.price || 0) * (item.quantity || 0);
                    }, 0);
                }
                
                // Phí vận chuyển
                const shippingFee = order.shippingFee || 0;
                
                // Giảm giá
                const discount = order.discount || 0;
                
                // Tổng cộng
                const grandTotal = subtotal + shippingFee - discount;
                %>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">Tạm tính:</span>
                    <span class="text-sm text-gray-900"><%= subtotal.toLocaleString('vi-VN') %>₫</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">Phí vận chuyển:</span>
                    <span class="text-sm text-gray-900"><%= shippingFee === 0 ? 'Miễn phí' : shippingFee.toLocaleString('vi-VN') + '₫' %></span>
                </div>
                <% if (discount > 0) { %>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">Giảm giá:</span>
                    <span class="text-sm text-green-600">-<%= discount.toLocaleString('vi-VN') %>₫</span>
                </div>
                <% } %>
                <div class="border-t border-gray-200 pt-3">
                    <div class="flex justify-between">
                        <span class="text-base font-semibold text-gray-900">Tổng cộng:</span>
                        <span class="text-base font-semibold text-gray-900"><%= grandTotal.toLocaleString('vi-VN') %>₫</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Thao tác</h3>
            <div class="space-y-3">
                <!-- Update Status -->
                <form method="POST" action="/admin/update-order-status" class="space-y-3">
                    <input type="hidden" name="orderId" value="<%= order._id %>">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cập nhật trạng thái</label>
                        <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="pending" <%= order.status === 'pending' ? 'selected' : '' %>>Chờ xử lý</option>
                            <option value="processing" <%= order.status === 'processing' ? 'selected' : '' %>>Đang xử lý</option>
                            <option value="shipped" <%= order.status === 'shipped' ? 'selected' : '' %>>Đã giao hàng</option>
                            <option value="completed" <%= order.status === 'completed' ? 'selected' : '' %>>Hoàn thành</option>
                            <option value="cancelled" <%= order.status === 'cancelled' ? 'selected' : '' %>>Đã hủy</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="ri-edit-line mr-2"></i>
                        Cập nhật trạng thái
                    </button>
                </form>

                <!-- Update Payment Status -->
                <form method="POST" action="/admin/update-payment-status" class="space-y-3">
                    <input type="hidden" name="orderId" value="<%= order._id %>">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cập nhật thanh toán</label>
                        <select name="paymentStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="pending" <%= order.paymentStatus === 'pending' ? 'selected' : '' %>>Chờ thanh toán</option>
                            <option value="paid" <%= order.paymentStatus === 'paid' ? 'selected' : '' %>>Đã thanh toán</option>
                            <option value="failed" <%= order.paymentStatus === 'failed' ? 'selected' : '' %>>Thanh toán thất bại</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="ri-money-dollar-circle-line mr-2"></i>
                        Cập nhật thanh toán
                    </button>
                </form>

                <!-- Download Invoice -->
                <a href="/admin/orders/<%= order._id %>/invoice" class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors text-center block">
                    <i class="ri-file-download-line mr-2"></i>
                    Tải hóa đơn
                </a>
            </div>
        </div>
    </div>
</div>
